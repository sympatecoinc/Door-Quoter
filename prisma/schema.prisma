generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x", "debian-openssl-1.1.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Project {
  id                     Int                @id @default(autoincrement())
  name                   String
  status                 ProjectStatus      @default(STAGING)
  customerId             Int?               // Optional - null for prospect leads until converted
  pricingModeId          Int?
  extrusionCostingMethod String             @default("FULL_STOCK") // "FULL_STOCK" | "PERCENTAGE_BASED"
  excludedPartNumbers    String[]           @default([]) // Part numbers to exclude from FULL_STOCK rule (use percentage-based instead)
  multiplier             Float              @default(1.0) // Price multiplier/markup for quotes (e.g., 1.2 = 20% markup)
  taxRate                Float              @default(0) // Tax rate as decimal (e.g., 0.08 for 8%)
  installationCost       Float              @default(0) // DEPRECATED - kept for backward compatibility, use manualInstallationCost
  installationMethod     String             @default("MANUAL") // "MANUAL" or "PER_PRODUCT_TOTAL"
  installationComplexity String             @default("STANDARD") // "SIMPLE", "STANDARD", "COMPLEX", "VERY_COMPLEX"
  manualInstallationCost Float              @default(0) // Manual installation cost (preserved when switching modes)
  quoteDrawingView       String             @default("ELEVATION") // "ELEVATION" or "PLAN" - which drawing view to show on quotes
  createdAt              DateTime           @default(now())
  updatedAt              DateTime           @updatedAt
  dueDate                DateTime?
  shipDate               DateTime?          // Expected ship/delivery date
  batchSize              Int?               // Default batch size for cut lists (null = all units)
  shippingAddress        String?            // Shipping street address
  shippingCity           String?            // Shipping city
  shippingState          String?            // Shipping state
  shippingZipCode        String?            // Shipping zip code
  primaryContactId       Int?               // Primary contact from customer's contacts
  primaryProjectContactId Int?              // Primary contact from project contacts
  // Prospect fields - used for leads without a customer
  prospectCompanyName    String?            // Company name for leads without customer
  prospectPhone          String?            // Phone number for prospect
  prospectAddress        String?            // Street address for prospect
  prospectCity           String?            // City for prospect
  prospectState          String?            // State for prospect
  prospectZipCode        String?            // Zip code for prospect
  boms                   BOM[]
  openings               Opening[]
  quoteAttachments       QuoteAttachment[]
  statusHistory          ProjectStatusHistory[]
  projectContacts        ProjectContact[]   // Project-specific contacts (architect, GC, etc.)
  projectNotes           ProjectNote[]      // Project notes
  quoteVersions          QuoteVersion[]     // Historical quote snapshots
  customer               Customer?          @relation("CustomerProjects", fields: [customerId], references: [id], onDelete: Restrict)
  pricingMode            PricingMode?       @relation(fields: [pricingModeId], references: [id], onDelete: SetNull)
  primaryContact         Contact?           @relation("ProjectPrimaryContact", fields: [primaryContactId], references: [id], onDelete: SetNull)
  primaryProjectContact  ProjectContact?    @relation("ProjectPrimaryProjectContact", fields: [primaryProjectContactId], references: [id], onDelete: SetNull)
  salesOrders            SalesOrder[]

  // Version tracking fields for project revisions
  version                Int         @default(1)
  parentProjectId        Int?
  isCurrentVersion       Boolean     @default(true)
  parentProject          Project?    @relation("ProjectRevisions", fields: [parentProjectId], references: [id], onDelete: SetNull)
  revisions              Project[]   @relation("ProjectRevisions")

  // Packing list access token for public QR scanning interface
  packingAccessToken     String?     @unique @default(uuid())

  @@map("Projects")
}

// Quote Version - Historical snapshots of quotes for tracking changes
model QuoteVersion {
  id               Int         @id @default(autoincrement())
  projectId        Int
  project          Project     @relation(fields: [projectId], references: [id], onDelete: Cascade)
  version          Int         // Auto-increment per project (1, 2, 3...)

  // Price summary (for quick display without parsing snapshot)
  subtotal         Float
  markupAmount     Float
  discountAmount   Float
  taxAmount        Float
  installationCost Float
  totalPrice       Float

  // Settings at time of quote
  pricingModeId    Int?
  pricingModeName  String?     // Denormalized for history (mode might be deleted later)
  taxRate          Float

  // Full data snapshot (openings, items, calculations)
  snapshot         Json

  // Version tracking
  changeNotes      String?     // Auto-generated or manual summary of changes

  // Send tracking
  sentAt           DateTime?
  sentTo           String?     // Email address

  // Metadata
  createdAt        DateTime    @default(now())
  createdBy        String?     // User email/name

  @@unique([projectId, version])
  @@index([projectId])
  @@map("QuoteVersions")
}

model ProjectStatusHistory {
  id        Int           @id @default(autoincrement())
  projectId Int
  status    ProjectStatus
  changedBy String?
  changedAt DateTime      @default(now())
  project   Project       @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@map("ProjectStatusHistory")
}

model Opening {
  id                    Int       @id @default(autoincrement())
  projectId             Int
  name                  String
  roughWidth            Float?
  roughHeight           Float?
  finishedWidth         Float?
  finishedHeight        Float?
  price                 Float     @default(0)
  extrusionCost         Float     @default(0) // Base cost of extrusions (for accurate markup calculation)
  hardwareCost          Float     @default(0) // Base cost of hardware (for accurate markup calculation)
  glassCost             Float     @default(0) // Base cost of glass (for accurate markup calculation)
  packagingCost         Float     @default(0) // Base cost of packaging (for accurate markup calculation)
  otherCost             Float     @default(0) // Base cost of other items (for accurate markup calculation)
  standardOptionCost    Float     @default(0) // Cost of standard options (no markup applied)
  hybridRemainingCost   Float     @default(0) // HYBRID pricing: remaining extrusion cost (no markup applied)
  multiplier            Float     @default(1.0) // Price multiplier/markup for this opening (e.g., 1.2 = 20% markup)
  priceCalculatedAt     DateTime? // Track when price was last calculated
  finishColor           String?   // Finish type for extrusions (e.g., "Mill Finish", "Powder Coated", "Anodized")
  includeStarterChannels Boolean  @default(false) // Whether to include starter channels (E-12306) in BOM
  // Finished Opening Tolerance Fields
  isFinishedOpening     Boolean   @default(false) // Whether this is a finished opening (applies tolerances)
  openingType           String?   // "THINWALL" or "FRAMED" - determines which default tolerances to use
  widthToleranceTotal   Float?    // Override: total inches to deduct from width (null = use defaults)
  heightToleranceTotal  Float?    // Override: total inches to deduct from height (null = use defaults)
  toleranceProductId    Int?      // ID of product that defined tolerances (first eligible product added)
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  project               Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  panels                Panel[]

  @@map("Openings")
}

model Panel {
  id                  Int                @id @default(autoincrement())
  openingId           Int
  type                String
  width               Float
  height              Float
  glassType           String
  locking             String
  swingDirection      String             @default("None")
  slidingDirection    String             @default("Left")
  isCorner            Boolean            @default(false)
  cornerDirection     String             @default("Up")
  displayOrder        Int                @default(0) // Order for display in UI
  componentLibraryId  Int?               // Link to component library for parametric SVGs
  createdAt           DateTime           @default(now())
  updatedAt           DateTime           @updatedAt
  componentInstance   ComponentInstance?
  componentLibrary    ComponentLibrary?  @relation(fields: [componentLibraryId], references: [id], onDelete: SetNull)
  opening             Opening            @relation(fields: [openingId], references: [id], onDelete: Cascade)
  // Paired panel support - for auto-added components like frames
  parentPanelId       Int?               // If set, this is a paired panel (hidden in UI)
  parentPanel         Panel?             @relation("PairedPanels", fields: [parentPanelId], references: [id], onDelete: Cascade)
  pairedPanels        Panel[]            @relation("PairedPanels")

  @@map("Panels")
}

enum ProjectStatus {
  STAGING        @map("Staging")
  APPROVED       @map("Approved")
  REVISE         @map("Revise")
  QUOTE_SENT     @map("Quote Sent")
  QUOTE_ACCEPTED @map("Quote Accepted")
  ACTIVE         @map("Active")
  COMPLETE       @map("Complete")
  ARCHIVE        @map("Archive")
}

enum ProductType {
  SWING_DOOR   @map("Swing Door")
  SLIDING_DOOR @map("Sliding Door")
  FIXED_PANEL  @map("Fixed Panel")
  CORNER_90    @map("90 Degree Corner")
  FRAME        @map("Frame")
}

enum ProductCategory {
  THINWALL @map("Thinwall")
  TRIMMED  @map("Trimmed")
  BOTH     @map("Both")
}

model Product {
  id                   Int                    @id @default(autoincrement())
  name                 String
  description          String?
  type                 String                 @default("Product")
  productType          ProductType            @default(SWING_DOOR)
  productCategory      ProductCategory        @default(BOTH)
  defaultWidth         Float?
  archived             Boolean                @default(false)
  glassWidthFormula    String?
  glassHeightFormula   String?
  glassQuantityFormula String?
  elevationImageData   String?                // Base64 encoded elevation image
  elevationFileName    String?                // Original elevation filename
  installationPrice    Float                  @default(0) // Installation cost for this product type (optional)
  minWidth             Float?                 // Minimum allowed width (inches)
  maxWidth             Float?                 // Maximum allowed width (inches)
  minHeight            Float?                 // Minimum allowed height (inches)
  maxHeight            Float?                 // Maximum allowed height (inches)
  widthTolerance       Float?                 // Product-specific width tolerance (null = use defaults)
  heightTolerance      Float?                 // Product-specific height tolerance (null = use defaults)
  createdAt            DateTime               @default(now())
  updatedAt            DateTime               @updatedAt
  componentInstances   ComponentInstance[]
  productBOMs          ProductBOM[]
  productSubOptions    ProductSubOption[]
  planViews            ProductPlanView[]
  productDocuments     ProductQuoteDocument[] // Documents associated with this product
  // Paired product support - auto-add another product when this one is added (e.g., door adds frame)
  pairedProductId      Int?                   // ID of product to auto-add as paired (e.g., Frame)
  pairedProduct        Product?               @relation("ProductPairing", fields: [pairedProductId], references: [id])
  pairedByProducts     Product[]              @relation("ProductPairing")

  @@map("Products")
}

model SubOptionCategory {
  id                Int                @id @default(autoincrement())
  name              String
  description       String?
  svgOriginId       String?            @unique  // Unique ID for SVG origin point (e.g., "origin-a1b2c3")
  excludeFromQuote  Boolean            @default(false) // When true, options in this category won't show on quote
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  individualOptions IndividualOption[]
  productSubOptions ProductSubOption[]

  @@map("SubOptionCategories")
}

model IndividualOption {
  id                          Int                @id @default(autoincrement())
  categoryId                  Int
  name                        String
  description                 String?
  partNumber                  String?
  addToPackingList            Boolean            @default(false)
  addFinishToPartNumber       Boolean            @default(false)
  elevationImagePath          String?            // Path to elevation view image
  elevationImageOriginalName  String?            // Original filename for elevation image
  planImagePath               String?            // Path to plan view image
  planImageOriginalName       String?            // Original filename for plan image
  isCutListItem               Boolean            @default(false) // When true, shows in ProductBOM for formula assignment
  createdAt                   DateTime           @default(now())
  updatedAt                   DateTime           @updatedAt
  category                    SubOptionCategory  @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  productSubOptionsAsStandard ProductSubOption[] @relation("StandardOption")
  productBOMs                 ProductBOM[]       // BOM entries for this option (per product)
  linkedParts                 OptionLinkedPart[] // Parts automatically added to BOM when this option is selected
  variants                    OptionVariant[]    // Named variants for this option (e.g., "Locking", "Non-Locking")

  @@map("IndividualOptions")
}

model ProductSubOption {
  id               Int                @id @default(autoincrement())
  productId        Int
  categoryId       Int
  standardOptionId Int?
  isMandatory      Boolean            @default(false)
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt
  category         SubOptionCategory  @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  product          Product            @relation(fields: [productId], references: [id], onDelete: Cascade)
  standardOption   IndividualOption?  @relation("StandardOption", fields: [standardOptionId], references: [id], onDelete: SetNull)

  @@unique([productId, categoryId])
  @@map("ProductSubOptions")
}

model BOM {
  id           Int      @id @default(autoincrement())
  projectId    Int
  materialType String
  partName     String
  quantity     Float
  unit         String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  project      Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@map("BOMs")
}

model ProductBOM {
  id          Int      @id @default(autoincrement())
  productId   Int
  optionId    Int?     // When set, this BOM entry is for a cut-list option (linked via IndividualOption)
  partType    String   @default("Hardware")
  partName    String
  description String?
  formula     String?
  variable    String?
  unit        String?
  quantity    Float?
  stockLength Float?
  partNumber            String?
  cost                  Float?
  isMilled              Boolean  @default(true) // Whether this extrusion requires milling (machining)
  addFinishToPartNumber Boolean  @default(false) // When true, append finish color code to hardware part number in BOM
  addToPackingList      Boolean  @default(false) // When true, this hardware item appears in the packing list
  quantityMode          String?  @default("FIXED") // "FIXED" or "RANGE" - determines if user can select quantity
  minQuantity           Float?   // For RANGE mode: minimum selectable quantity
  maxQuantity           Float?   // For RANGE mode: maximum selectable quantity
  defaultQuantity       Float?   // For RANGE mode: pre-selected default quantity
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  product               Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  option                IndividualOption? @relation(fields: [optionId], references: [id], onDelete: Cascade)

  @@map("ProductBOMs")
}

model ComponentInstance {
  id                  Int      @id @default(autoincrement())
  panelId             Int      @unique
  productId           Int
  subOptionSelections String
  includedOptions     String   @default("[]") // JSON array: [optionId1, optionId2, ...] - options marked as included (no charge)
  variantSelections   String   @default("{}") // JSON: { [optionId]: variantId } - selected variant for each option
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  product             Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  panel               Panel    @relation(fields: [panelId], references: [id], onDelete: Cascade)

  @@map("ComponentInstances")
}

model MasterPart {
  id                      Int                @id @default(autoincrement())
  partNumber              String             @unique
  baseName                String
  description             String?
  unit                    String?
  cost                    Float?
  salePrice               Float?             // Fixed sale price - bypasses all markup calculations when set
  weightPerUnit           Float?             // Weight in ounces for Hardware parts
  weightPerFoot           Float?             // Weight in ounces per linear foot for Extrusion parts
  perimeterInches         Float?             // Perimeter in inches for surface area finish pricing
  customPricePerLb        Float?             // Per-extrusion override for material price per pound (null = use global)
  partType                String             @default("Hardware")
  isMillFinish            Boolean            @default(false) // If true (for Extrusions), no finish codes (-BL, -C2, -AL) will be appended to part numbers
  isOption                Boolean            @default(false) // True if this hardware part can be used as a category option
  optionImagePath         String?            // Path to uploaded image for category options (relative to public/)
  optionImageOriginalName String?            // Original filename of uploaded image
  addFinishToPartNumber   Boolean            @default(false) // When true, append finish color code to hardware part number in BOM
  appendDirectionToPartNumber Boolean        @default(false) // When true, append swing/sliding direction suffix (from plan view name) to part number in BOM
  addToPackingList        Boolean            @default(false) // When true, this hardware item appears in the packing list
  pickListStation         String?            // Pick list station: null=not on list, "Jamb Station", "Assembly"
  includeInJambKit        Boolean            @default(false) // When true, marked as Jamb Kit item on pick list
  createdAt               DateTime           @default(now())
  updatedAt               DateTime           @updatedAt
  stockLengthRules        StockLengthRule[]
  pricingRules            PricingRule[]
  glassTypeParts          GlassTypePart[]
  extrusionVariants       ExtrusionVariant[]

  // Inventory Management Fields
  qtyOnHand               Float?     @default(0)     // Current quantity in stock
  qtyReserved             Float      @default(0)     // Quantity reserved for confirmed SOs
  binLocationLegacy       String?    @map("binLocation") // DEPRECATED: Legacy bin location string (kept for migration)
  binLocationId           Int?                        // Physical bin/location reference
  binLocationRef          BinLocation? @relation(fields: [binLocationId], references: [id], onDelete: SetNull)
  reorderPoint            Float?                      // Qty threshold to trigger reorder
  reorderQty              Float?                      // Qty to order when reordering
  vendorId                Int?                        // Preferred vendor for this part
  vendor                  Vendor?    @relation(fields: [vendorId], references: [id], onDelete: SetNull)

  // QuickBooks Item link (for PO integration)
  quickbooksItem          QuickBooksItem?

  // Inventory notifications for this part
  notifications           InventoryNotification[]

  // Option linked parts - parts added when an option is selected
  optionLinkedParts       OptionLinkedPart[]

  // Sales Order Parts - parts reserved/picked for sales orders
  salesOrderParts         SalesOrderPart[]

  // Price history for this part
  priceHistory            PriceHistory[]

  @@map("MasterParts")
}

// Inventory Notification - Alerts for inventory-related actions (e.g., new part added)
model InventoryNotification {
  id            Int         @id @default(autoincrement())
  type          String      // "new_part_added", future: "low_stock", "reorder_needed"
  message       String
  masterPartId  Int?
  masterPart    MasterPart? @relation(fields: [masterPartId], references: [id], onDelete: Cascade)
  actionType    String?     // "setup_part", future: "reorder", "view_details"
  isDismissed   Boolean     @default(false)
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  @@map("InventoryNotifications")
}

model StockLengthRule {
  id             Int        @id @default(autoincrement())
  name           String
  description    String?
  minHeight      Float?
  maxHeight      Float?
  minWidth       Float?
  maxWidth       Float?
  stockLength    Float?     // For inch-based parts
  piecesPerUnit  Float?     // For unit-based parts
  maxLength      Float?     // Maximum length constraint
  maxLengthAppliesTo String? @default("height") // "height" or "width" - what the max length constraint is based on
  appliesTo      String     @default("height") // "height", "width", or "both"
  partType       String     @default("Extrusion")
  isActive       Boolean    @default(true)
  // Pricing fields for extrusions (pricing based on stock length)
  basePrice      Float?     // Base price for extrusions
  weightPerFoot  Float?     // Weight in ounces per linear foot for extrusions
  formula        String?    // e.g., "basePrice * (stockLength / 96)" or "basePrice * quantity"
  minQuantity    Float?
  maxQuantity    Float?
  masterPartId   Int        // Required - always tied to a master part
  masterPart     MasterPart @relation(fields: [masterPartId], references: [id], onDelete: Cascade)
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt

  @@map("StockLengthRules")
}

model PricingRule {
  id           Int        @id @default(autoincrement())
  name         String
  description  String?
  basePrice    Float?
  formula      String?    // e.g., "basePrice * quantity" or "width * height * pricePerSqFt"
  minQuantity  Float?
  maxQuantity  Float?
  partType     String     @default("Hardware")
  category     String?
  isActive     Boolean    @default(true)
  masterPartId Int        // Required - always tied to a master part
  masterPart   MasterPart @relation(fields: [masterPartId], references: [id], onDelete: Cascade)
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  @@map("PricingRules")
}

// CRM Models
model Customer {
  id          Int        @id @default(autoincrement())
  companyName String
  contactName String?
  email       String?    @unique
  phone       String?
  address     String?
  city        String?
  state       String?
  zipCode     String?
  country     String?    @default("USA")
  status      String     @default("Active") // Active, Lead, Archived
  source      String?    // How they found us
  notes       String?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  // QuickBooks sync fields
  quickbooksId  String?   @unique  // QB Customer Id
  syncToken     String?   // QB sync token for updates
  lastSyncedAt  DateTime? // When last synced with QB

  contacts    Contact[]
  leads       Lead[]
  projects    Project[]  @relation("CustomerProjects")
  activities  Activity[]
  files       CustomerFile[]
  salesOrders SalesOrder[]
  invoices    Invoice[]

  @@map("Customers")
}

model Contact {
  id         Int       @id @default(autoincrement())
  customerId Int
  firstName  String
  lastName   String
  email      String?
  phone      String?
  title      String?
  isPrimary  Boolean   @default(false)
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  customer   Customer  @relation(fields: [customerId], references: [id], onDelete: Cascade)
  projects   Project[] @relation("ProjectPrimaryContact")

  @@map("Contacts")
}

model Lead {
  id          Int        @id @default(autoincrement())
  customerId  Int?
  title       String
  description String?
  value       Float?     // Estimated project value
  probability Int        @default(50) // Percentage 0-100
  stage       String     @default("New") // New, Qualified, Proposal, Negotiation, Won, Lost
  source      String?    // Website, Referral, Cold Call, etc.
  expectedCloseDate DateTime?
  actualCloseDate   DateTime?
  lostReason  String?    // If stage is Lost
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  customer    Customer?  @relation(fields: [customerId], references: [id], onDelete: SetNull)
  activities  Activity[]

  @@map("Leads")
}

model Activity {
  id          Int      @id @default(autoincrement())
  leadId      Int?
  customerId  Int?
  type        String   // Call, Email, Meeting, Note, Task
  subject     String
  description String?
  dueDate     DateTime?
  completed   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  lead        Lead?    @relation(fields: [leadId], references: [id], onDelete: Cascade)
  customer    Customer? @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@map("Activities")
}

model CustomerFile {
  id           Int      @id @default(autoincrement())
  customerId   Int
  filename     String   // Stored filename
  originalName String   // Original upload filename
  mimeType     String
  size         Int      // File size in bytes
  uploadedBy   String?  // User who uploaded the file
  createdAt    DateTime @default(now())
  customer     Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@map("CustomerFiles")
}

// Quote Attachments - Spec sheets, photos, etc. for quotes
model QuoteAttachment {
  id           Int      @id @default(autoincrement())
  projectId    Int
  filename     String   // Stored filename in uploads/quote-attachments/[projectId]/
  originalName String   // Original upload filename
  mimeType     String   // image/png, image/jpeg, application/pdf
  size         Int      // File size in bytes
  type         String   @default("custom") // "spec_sheet", "photo", "custom"
  displayOrder Int      @default(0) // Order in the PDF
  position     String   @default("after") // "before" or "after" - position relative to persistent documents
  description  String?  // Optional description/caption
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  project      Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@map("QuoteAttachments")
}

// Project Contacts - Architects, GCs, and other project-specific contacts
model ProjectContact {
  id               Int       @id @default(autoincrement())
  projectId        Int
  contactType      String    // "ARCHITECT" | "GENERAL_CONTRACTOR" | "OTHER"
  companyName      String?
  name             String
  email            String?
  phone            String?
  notes            String?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  project          Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  primaryForProjects Project[] @relation("ProjectPrimaryProjectContact")

  @@map("ProjectContacts")
}

// Project Notes - Notes specific to a project
model ProjectNote {
  id        Int      @id @default(autoincrement())
  projectId Int
  content   String   @db.Text
  createdBy String?  // User who created the note
  updatedBy String?  // User who last updated the note
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@map("ProjectNotes")
}

// Component Library for SHOPGEN Integration
model ComponentLibrary {
  id                   Int      @id @default(autoincrement())
  name                 String   @unique
  description          String?
  hasSwingDirection    Boolean  @default(false)
  hasSlidingDirection  Boolean  @default(false)
  elevationImageData   String?  // Base64 encoded SVG/PNG data
  planImageData        String?  // Base64 encoded SVG/PNG data
  elevationFileName    String?  // Original filename
  planFileName         String?  // Original filename
  isParametric         Boolean  @default(true) // Whether this component uses parametric scaling
  productType          ProductType @default(SWING_DOOR)
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  panels               Panel[]  // Panels using this component

  @@map("ComponentLibrary")
}

// Product Views - Multiple named views per product for swing/sliding directions
// Each view contains both plan and elevation images
model ProductPlanView {
  id                 Int      @id @default(autoincrement())
  productId          Int
  name               String   // e.g., "Right In", "Left Out", "Fixed Panel"
  // Plan view image
  imageData          String   // Base64 encoded plan view image
  fileName           String?  // Original plan filename
  fileType           String   @default("image/png") // MIME type of the plan file
  orientation        String   @default("bottom") // "bottom" (align top) or "top" (align bottom)
  referenceWidth     Float?   // Real-world width (in inches) the image depicts, for PNG scaling
  // Elevation view image
  elevationImageData String?  // Base64 encoded elevation view image
  elevationFileName  String?  // Original elevation filename
  elevationFileType  String?  // MIME type of the elevation file
  // Common fields
  displayOrder       Int      @default(0) // Order for display in UI
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  product            Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@map("ProductPlanViews")
}

// Add customer relationship to existing Project model

// Glass Types - Pricing for glass by square foot
model GlassType {
  id           Int             @id @default(autoincrement())
  name         String          @unique
  description  String?
  pricePerSqFt Float
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt
  parts        GlassTypePart[]

  @@map("GlassTypes")
}

// Glass Type Parts - Hardware/Other parts attached to glass types (like vinyl frosting)
model GlassTypePart {
  id           Int        @id @default(autoincrement())
  glassTypeId  Int
  masterPartId Int
  formula      String?    // e.g., "height" or "height / 12" for linear feet, "2" for fixed qty
  quantity     Float?     // Fixed quantity if no formula (default: 1)
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  glassType    GlassType  @relation(fields: [glassTypeId], references: [id], onDelete: Cascade)
  masterPart   MasterPart @relation(fields: [masterPartId], references: [id], onDelete: Cascade)

  @@unique([glassTypeId, masterPartId])
  @@map("GlassTypeParts")
}

// Option Linked Parts - Parts automatically included when an option is selected (e.g., handle requires hook lock)
model OptionLinkedPart {
  id           Int              @id @default(autoincrement())
  optionId     Int
  masterPartId Int
  variantId    Int?             // null = applies to all variants, set = variant-specific
  quantity     Float            @default(1) // Fixed quantity to add
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt
  option       IndividualOption @relation(fields: [optionId], references: [id], onDelete: Cascade)
  masterPart   MasterPart       @relation(fields: [masterPartId], references: [id], onDelete: Cascade)
  variant      OptionVariant?   @relation(fields: [variantId], references: [id], onDelete: Cascade)

  @@unique([optionId, masterPartId, variantId])
  @@map("OptionLinkedParts")
}

// Option Variants - Named variants for options (e.g., "Locking" / "Non-Locking" for handles)
model OptionVariant {
  id          Int              @id @default(autoincrement())
  optionId    Int
  name        String           // e.g., "Locking", "Non-Locking"
  isDefault   Boolean          @default(false)
  sortOrder   Int              @default(0)
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  option      IndividualOption @relation(fields: [optionId], references: [id], onDelete: Cascade)
  linkedParts OptionLinkedPart[]

  @@map("OptionVariants")
}

// Pricing Modes - Configurable pricing strategies for projects
model PricingMode {
  id                     Int       @id @default(autoincrement())
  name                   String    @unique
  description            String?
  isDefault              Boolean   @default(false)
  markup                 Float     @default(0) // Global markup percentage (e.g., 20 for 20%) - kept for backward compatibility
  extrusionMarkup        Float     @default(0) // Extrusion-specific markup percentage
  hardwareMarkup         Float     @default(0) // Hardware-specific markup percentage
  glassMarkup            Float     @default(0) // Glass-specific markup percentage
  packagingMarkup        Float     @default(0) // Packaging-specific markup percentage
  discount               Float     @default(0) // Global discount percentage (e.g., 10 for 10%)
  extrusionCostingMethod String    @default("FULL_STOCK") // "FULL_STOCK" | "PERCENTAGE_BASED" | "HYBRID" - how to cost extrusions
  createdAt              DateTime  @default(now())
  updatedAt              DateTime  @updatedAt
  projects               Project[]

  @@map("PricingModes")
}

// Authentication and User Management
enum Role {
  ADMIN
  MANAGER
  VIEWER
}

model Profile {
  id          Int      @id @default(autoincrement())
  name        String   @unique
  description String?
  tabs        String[] @default([])
  defaultTab  String?  // The tab users land on by default (must be in tabs array)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  users       User[]

  @@map("Profiles")
}

model User {
  id           Int       @id @default(autoincrement())
  email        String    @unique
  passwordHash String
  name         String
  role         Role      @default(VIEWER)
  isActive     Boolean   @default(true)
  permissions  String[]  @default(["dashboard", "projects", "crm", "products", "masterParts", "vendors", "quoteDocuments", "accounting", "settings"]) // Available tabs for user (legacy, fallback when no profile)
  profileId    Int?
  profile      Profile?  @relation(fields: [profileId], references: [id], onDelete: SetNull)
  tabOverrides String    @default("{}") // JSON: {"add": [], "remove": []} - overrides beyond profile
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  sessions     Session[]

  // PO Relations
  createdPOs        PurchaseOrder[]   @relation("POCreatedBy")
  receivedPOs       POReceiving[]     @relation("POReceivedBy")
  poStatusChanges   POStatusHistory[] @relation("POStatusChangedBy")

  // SO Relations
  createdSOs        SalesOrder[]      @relation("SOCreatedBy")
  pickedParts       SalesOrderPart[]  @relation("PartPickedBy")

  // Invoice Relations
  createdInvoices   Invoice[]         @relation("InvoiceCreatedBy")

  @@map("Users")
}

model Session {
  id        String   @id @default(uuid())
  userId    Int
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("Sessions")
}

// Quote Documents - Persistent documents that can be included in quotes
model QuoteDocument {
  id               Int                    @id @default(autoincrement())
  name             String                 // Display name
  description      String?                // Optional description
  filename         String                 // Stored filename (unique identifier)
  originalName     String                 // Original upload filename
  mimeType         String                 // File MIME type
  size             Int                    // File size in bytes
  category         String                 @default("general") // "spec_sheet", "brochure", "warranty", "installation", "general"
  isGlobal         Boolean                @default(true) // If true, included in all quotes
  displayOrder     Int                    @default(0) // Order in PDFs
  uploadedBy       String?                // User who uploaded
  createdAt        DateTime               @default(now())
  updatedAt        DateTime               @updatedAt
  productDocuments ProductQuoteDocument[] // Products this document is associated with

  @@map("QuoteDocuments")
}

// Junction table linking products to quote documents
model ProductQuoteDocument {
  id              Int           @id @default(autoincrement())
  productId       Int
  quoteDocumentId Int
  createdAt       DateTime      @default(now())
  product         Product       @relation(fields: [productId], references: [id], onDelete: Cascade)
  quoteDocument   QuoteDocument @relation(fields: [quoteDocumentId], references: [id], onDelete: Cascade)

  @@unique([productId, quoteDocumentId])
  @@map("ProductQuoteDocuments")
}

// Extrusion Finish Pricing - Global settings for finish costs per square foot
model ExtrusionFinishPricing {
  id                Int                @id @default(autoincrement())
  finishType        String             @unique // e.g., "Mill Finish", "Powder Coated", "Anodized"
  finishCode        String?            // Part number suffix code (e.g., "BL", "C2", "AL")
  costPerSqFt       Float              @default(0) // Cost per square foot of surface
  isActive          Boolean            @default(true)
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  extrusionVariants ExtrusionVariant[]

  @@map("ExtrusionFinishPricing")
}

// Extrusion Variants - Track inventory by length and color combinations
model ExtrusionVariant {
  id               Int                     @id @default(autoincrement())
  masterPartId     Int
  stockLength      Float                   // Stock length in inches (e.g., 144 = 12ft)
  finishPricingId  Int?                    // null = Mill Finish
  qtyOnHand        Float                   @default(0)     // Current quantity in stock (pieces)
  binLocationLegacy String?   @map("binLocation") // DEPRECATED: Legacy bin location string (kept for migration)
  binLocationId    Int?                    // Physical bin/location reference
  binLocationRef   BinLocation?            @relation(fields: [binLocationId], references: [id], onDelete: SetNull)
  reorderPoint     Float?                  // Qty threshold to trigger reorder
  reorderQty       Float?                  // Qty to order when reordering
  pricePerPiece    Float?                  // Price per stock piece (e.g., $45 for 12ft stick)
  isActive         Boolean                 @default(true)  // Whether this variant is currently stocked
  notes            String?                 // Any notes about this variant
  createdAt        DateTime                @default(now())
  updatedAt        DateTime                @updatedAt

  masterPart      MasterPart              @relation(fields: [masterPartId], references: [id], onDelete: Cascade)
  finishPricing   ExtrusionFinishPricing? @relation(fields: [finishPricingId], references: [id], onDelete: SetNull)

  @@unique([masterPartId, stockLength, finishPricingId])
  @@map("ExtrusionVariants")
}

// Vendor Management - QuickBooks integrated vendor database
model Vendor {
  id                  Int             @id @default(autoincrement())
  // QuickBooks sync fields
  quickbooksId        String?         @unique  // QB vendor Id
  syncToken           String?         // QB sync token for updates
  lastSyncedAt        DateTime?       // When last synced with QB

  // Core vendor info (maps to QB fields)
  displayName         String          // QB: DisplayName (required)
  companyName         String?         // QB: CompanyName
  givenName           String?         // QB: GivenName (first name if individual)
  familyName          String?         // QB: FamilyName (last name if individual)
  printOnCheckName    String?         // QB: PrintOnCheckName

  // Contact info
  primaryEmail        String?         // QB: PrimaryEmailAddr.Address
  primaryPhone        String?         // QB: PrimaryPhone.FreeFormNumber
  alternatePhone      String?         // QB: AlternatePhone.FreeFormNumber
  mobile              String?         // QB: Mobile.FreeFormNumber
  fax                 String?         // QB: Fax.FreeFormNumber
  website             String?         // QB: WebAddr.URI

  // Billing Address
  billAddressLine1    String?         // QB: BillAddr.Line1
  billAddressLine2    String?         // QB: BillAddr.Line2
  billAddressCity     String?         // QB: BillAddr.City
  billAddressState    String?         // QB: BillAddr.CountrySubDivisionCode
  billAddressZip      String?         // QB: BillAddr.PostalCode
  billAddressCountry  String?         // QB: BillAddr.Country

  // Business details
  taxIdentifier       String?         // QB: TaxIdentifier
  acctNum             String?         // QB: AcctNum (account number)
  vendor1099          Boolean         @default(false) // QB: Vendor1099
  balance             Float?          // QB: Balance (read-only from QB)

  // Terms and payment
  termRefId           String?         // QB: TermRef.value (Net 30, etc.)
  termRefName         String?         // QB: TermRef.name

  // Notes
  notes               String?         @db.Text // QB: Notes (max 1024 chars)

  // AlumERP-specific fields (not synced to QB)
  category            String?         // Aluminum, Hardware, Glass, etc.
  code                String?         // Short code e.g., "SYMPATECO"
  isActive            Boolean         @default(true) // QB: Active

  // Default expense account for PO line items (QB Account reference)
  defaultExpenseAccountId   String?   // QB Account Id for expense categorization
  defaultExpenseAccountName String?   // QB Account Name (for display)

  createdAt           DateTime        @default(now())
  updatedAt           DateTime        @updatedAt
  contacts            VendorContact[]
  masterParts         MasterPart[]    // Parts supplied by this vendor
  purchaseOrders      PurchaseOrder[] // Purchase orders to this vendor
  priceHistory        PriceHistory[]  // Price history for this vendor

  @@map("Vendors")
}

model VendorContact {
  id          Int      @id @default(autoincrement())
  vendorId    Int
  name        String
  title       String?
  email       String?
  phone       String?
  mobile      String?
  isPrimary   Boolean  @default(false)
  notes       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  vendor      Vendor   @relation(fields: [vendorId], references: [id], onDelete: Cascade)

  @@map("VendorContacts")
}

// QuickBooks OAuth Token Storage
model QuickBooksToken {
  id            Int      @id @default(autoincrement())
  realmId       String   @unique // QuickBooks company ID
  accessToken   String   @db.Text
  refreshToken  String   @db.Text
  tokenType     String   @default("Bearer")
  expiresAt     DateTime
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@map("QuickBooksTokens")
}

// Global Application Settings - Key-value store for system-wide settings
model GlobalSetting {
  id          Int      @id @default(autoincrement())
  key         String   @unique
  value       String
  dataType    String   @default("number") // "string", "number", "boolean", "json"
  category    String?  // Optional grouping (e.g., "pricing", "inventory")
  description String?  // Human-readable description
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("GlobalSettings")
}

// Bin Location - Physical storage locations for inventory
model BinLocation {
  id              Int       @id @default(autoincrement())
  code            String    @unique  // Short unique code (e.g., "A-01-1")
  name            String               // Display name (e.g., "Aisle A, Rack 1, Shelf 1")
  description     String?              // Optional description
  accessToken     String    @unique @default(uuid()) // UUID for public URL access
  isActive        Boolean   @default(true)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  masterParts       MasterPart[]
  extrusionVariants ExtrusionVariant[]

  @@map("BinLocations")
}

// QuickBooks Item - Synced items from QuickBooks for PO line items
model QuickBooksItem {
  id                  Int       @id @default(autoincrement())
  // QuickBooks sync fields
  quickbooksId        String    @unique  // QB Item Id
  syncToken           String?   // QB sync token for updates
  lastSyncedAt        DateTime? // When last synced with QB

  // Core item info (maps to QB fields)
  name                String    // QB: Name (required, max 100 chars)
  sku                 String?   // QB: Sku
  description         String?   // QB: Description
  type                String    // QB: Type (Service, Inventory, NonInventory, etc.)
  active              Boolean   @default(true) // QB: Active

  // Pricing
  unitPrice           Float?    // QB: UnitPrice (sales price)
  purchaseCost        Float?    // QB: PurchaseCost (cost when purchasing)
  purchaseDesc        String?   // QB: PurchaseDesc

  // Inventory tracking
  trackQtyOnHand      Boolean   @default(false) // QB: TrackQtyOnHand
  qtyOnHand           Float?    // QB: QtyOnHand
  reorderPoint        Float?    // QB: ReorderPoint

  // Account references (stored as QB IDs)
  incomeAccountRefId  String?   // QB: IncomeAccountRef.value
  expenseAccountRefId String?   // QB: ExpenseAccountRef.value
  assetAccountRefId   String?   // QB: AssetAccountRef.value

  // Vendor reference
  prefVendorRefId     String?   // QB: PrefVendorRef.value
  prefVendorRefName   String?   // QB: PrefVendorRef.name

  // Link to local MasterPart (optional)
  masterPartId        Int?      @unique
  masterPart          MasterPart? @relation(fields: [masterPartId], references: [id], onDelete: SetNull)

  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
  purchaseOrderLines  PurchaseOrderLine[]

  @@map("QuickBooksItems")
}

// Purchase Order Status enum
enum POStatus {
  DRAFT        @map("Draft")
  SENT         @map("Sent")
  ACKNOWLEDGED @map("Acknowledged")
  PARTIAL      @map("Partial")
  COMPLETE     @map("Complete")
  CANCELLED    @map("Cancelled")
  ON_HOLD      @map("On Hold")
}

// Purchase Order - Local cache of QuickBooks Purchase Orders
model PurchaseOrder {
  id                    Int       @id @default(autoincrement())
  // QuickBooks sync fields
  quickbooksId          String?   @unique  // QB PurchaseOrder Id
  syncToken             String?   // QB sync token for updates
  lastSyncedAt          DateTime? // When last synced with QB

  // PO identification
  poNumber              String    @unique  // Auto-generated: PO-2024-0001
  docNumber             String?   // QB: DocNumber (may differ from poNumber)

  // Vendor reference
  vendorId              Int
  vendor                Vendor    @relation(fields: [vendorId], references: [id], onDelete: Restrict)

  // Status & workflow
  status                POStatus  @default(DRAFT)
  manuallyClosed        Boolean   @default(false) // QB: ManuallyClosed

  // Dates
  txnDate               DateTime  @default(now()) // QB: TxnDate (order date)
  expectedDate          DateTime? // QB: ExpectedDate (expected delivery)
  dueDate               DateTime? // QB: DueDate

  // Shipping address
  shipAddrLine1         String?
  shipAddrLine2         String?
  shipAddrCity          String?
  shipAddrState         String?
  shipAddrPostalCode    String?
  shipAddrCountry       String?

  // Totals (calculated from line items or from QB)
  subtotal              Float     @default(0)
  taxAmount             Float     @default(0)
  shippingAmount        Float     @default(0)
  totalAmount           Float     @default(0) // QB: TotalAmt

  // Notes
  memo                  String?   @db.Text // QB: Memo (visible to vendor)
  privateNote           String?   @db.Text // QB: PrivateNote (internal)

  // Audit trail
  createdById           Int?
  createdBy             User?     @relation("POCreatedBy", fields: [createdById], references: [id], onDelete: SetNull)

  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  // Relations
  lines                 PurchaseOrderLine[]
  receivings            POReceiving[]
  statusHistory         POStatusHistory[]

  @@map("PurchaseOrders")
}

// Purchase Order Line Item
model PurchaseOrderLine {
  id                    Int       @id @default(autoincrement())
  purchaseOrderId       Int
  purchaseOrder         PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)

  // Line number for ordering
  lineNum               Int       @default(0)

  // Item reference (QB Item or description-based)
  quickbooksItemId      Int?      // Link to synced QB Item
  quickbooksItem        QuickBooksItem? @relation(fields: [quickbooksItemId], references: [id], onDelete: SetNull)
  itemRefId             String?   // QB: ItemBasedExpenseLineDetail.ItemRef.value
  itemRefName           String?   // QB: ItemBasedExpenseLineDetail.ItemRef.name

  // Line details
  description           String?   // QB: Description
  quantity              Float     @default(1) // QB: Qty
  unitPrice             Float     @default(0) // QB: UnitPrice (cost per unit)
  amount                Float     @default(0) // QB: Amount (qty * unitPrice)

  // Receiving tracking
  quantityReceived      Float     @default(0)
  quantityRemaining     Float     @default(0) // Calculated: quantity - quantityReceived

  // Notes
  notes                 String?

  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  receivingLines        POReceivingLine[]

  @@map("PurchaseOrderLines")
}

// PO Receiving - Record of items received against a PO
model POReceiving {
  id                    Int       @id @default(autoincrement())
  purchaseOrderId       Int
  purchaseOrder         PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)

  // Receiving details
  receivedDate          DateTime  @default(now())
  receivedById          Int?
  receivedBy            User?     @relation("POReceivedBy", fields: [receivedById], references: [id], onDelete: SetNull)

  // Notes
  notes                 String?   @db.Text
  qualityNotes          String?   @db.Text // Quality inspection notes

  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  // Receiving line items
  lines                 POReceivingLine[]

  @@map("POReceivings")
}

// PO Receiving Line - Individual line items received
model POReceivingLine {
  id                    Int       @id @default(autoincrement())
  receivingId           Int
  receiving             POReceiving @relation(fields: [receivingId], references: [id], onDelete: Cascade)

  // Link to PO line
  purchaseOrderLineId   Int
  purchaseOrderLine     PurchaseOrderLine @relation(fields: [purchaseOrderLineId], references: [id], onDelete: Cascade)

  // Quantities
  quantityReceived      Float     @default(0)
  quantityDamaged       Float     @default(0) // Damaged items received
  quantityRejected      Float     @default(0) // Rejected items

  // Notes for this specific line
  notes                 String?

  createdAt             DateTime  @default(now())

  @@map("POReceivingLines")
}

// PO Status History - Audit trail for status changes
model POStatusHistory {
  id                    Int       @id @default(autoincrement())
  purchaseOrderId       Int
  purchaseOrder         PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)

  fromStatus            POStatus?
  toStatus              POStatus
  changedById           Int?
  changedBy             User?     @relation("POStatusChangedBy", fields: [changedById], references: [id], onDelete: SetNull)
  notes                 String?
  changedAt             DateTime  @default(now())

  @@map("POStatusHistory")
}

// Sales Order Status enum (synced to QuickBooks)
enum SOStatus {
  DRAFT              @map("Draft")
  CONFIRMED          @map("Confirmed")
  SENT               @map("Sent")
  VIEWED             @map("Viewed")
  PARTIAL            @map("Partial")
  PAID               @map("Paid")
  PARTIALLY_INVOICED @map("Partially Invoiced")
  FULLY_INVOICED     @map("Fully Invoiced")
  OVERDUE            @map("Overdue")
  VOIDED             @map("Voided")
  CANCELLED          @map("Cancelled")
}

// Invoice Status enum (synced with QuickBooks Invoices)
enum InvoiceStatus {
  DRAFT        @map("Draft")
  SENT         @map("Sent")
  VIEWED       @map("Viewed")
  PARTIAL      @map("Partial")
  PAID         @map("Paid")
  OVERDUE      @map("Overdue")
  VOIDED       @map("Voided")
}

// Sales Order - Synced to QuickBooks as Estimates
// Sales orders are created from accepted quotes and can generate invoices
model SalesOrder {
  id                    Int       @id @default(autoincrement())
  // QuickBooks sync fields
  quickbooksId          String?   @unique  // QB Estimate Id
  syncToken             String?   // QB sync token for updates
  lastSyncedAt          DateTime? // When last synced with QB

  // Identification
  orderNumber           String    @unique  // SO-2024-0001
  docNumber             String?   // QB DocNumber

  // Customer reference
  customerId            Int
  customer              Customer  @relation(fields: [customerId], references: [id], onDelete: Restrict)

  // Project reference (for orders from quotes)
  projectId             Int?
  project               Project?  @relation(fields: [projectId], references: [id], onDelete: SetNull)

  // Status & dates
  status                SOStatus  @default(DRAFT)
  txnDate               DateTime  @default(now())
  dueDate               DateTime?
  shipDate              DateTime?

  // Billing Address
  billAddrLine1         String?
  billAddrLine2         String?
  billAddrCity          String?
  billAddrState         String?
  billAddrPostalCode    String?
  billAddrCountry       String?

  // Shipping Address
  shipAddrLine1         String?
  shipAddrLine2         String?
  shipAddrCity          String?
  shipAddrState         String?
  shipAddrPostalCode    String?
  shipAddrCountry       String?

  // Totals
  subtotal              Float     @default(0)
  taxAmount             Float     @default(0)
  totalAmount           Float     @default(0)
  balance               Float     @default(0)

  // Notes
  customerMemo          String?   @db.Text // Visible to customer
  privateNote           String?   @db.Text // Internal only

  // Audit
  createdById           Int?
  createdBy             User?     @relation("SOCreatedBy", fields: [createdById], references: [id], onDelete: SetNull)

  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  // Relations
  lines                 SalesOrderLine[]
  parts                 SalesOrderPart[]  // Parts breakdown with fulfillment status
  invoices              Invoice[]  // Invoices generated from this SO

  @@map("SalesOrders")
}

// Sales Order Part Status enum
enum SOPartStatus {
  PENDING     @map("Pending")
  RESERVED    @map("Reserved")
  PICKED      @map("Picked")
  PACKED      @map("Packed")
  SHIPPED     @map("Shipped")
  CANCELLED   @map("Cancelled")
}

// Sales Order Part - Individual parts breakdown from project BOM with fulfillment tracking
model SalesOrderPart {
  id              Int           @id @default(autoincrement())
  salesOrderId    Int
  salesOrder      SalesOrder    @relation(fields: [salesOrderId], references: [id], onDelete: Cascade)

  // Part reference
  masterPartId    Int?
  masterPart      MasterPart?   @relation(fields: [masterPartId], references: [id], onDelete: SetNull)
  partNumber      String        // Full part number (with finish code, stock length)
  partName        String
  partType        String        // Extrusion, Hardware, Glass, Option, etc.

  // Quantity & dimensions
  quantity        Float         @default(1)
  unit            String        @default("EA")
  cutLength       Float?        // For extrusions

  // Source tracking
  openingName     String?
  productName     String?

  // Fulfillment status
  status          SOPartStatus  @default(PENDING)
  qtyPicked       Float         @default(0)
  qtyPacked       Float         @default(0)
  qtyShipped      Float         @default(0)

  // Timestamps
  pickedAt        DateTime?
  packedAt        DateTime?
  shippedAt       DateTime?
  pickedById      Int?
  pickedBy        User?         @relation("PartPickedBy", fields: [pickedById], references: [id], onDelete: SetNull)

  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@map("SalesOrderParts")
}

// Sales Order Line Item
model SalesOrderLine {
  id                    Int       @id @default(autoincrement())
  salesOrderId          Int
  salesOrder            SalesOrder @relation(fields: [salesOrderId], references: [id], onDelete: Cascade)

  // Line number for ordering
  lineNum               Int       @default(0)

  // Item reference
  itemRefId             String?
  itemRefName           String?

  // Line details
  description           String?
  quantity              Float     @default(1)
  unitPrice             Float     @default(0)
  amount                Float     @default(0)

  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@map("SalesOrderLines")
}

// Invoice - Synced with QuickBooks Invoices
// Invoices are generated from Sales Orders and synced to QuickBooks
model Invoice {
  id                    Int            @id @default(autoincrement())
  // QuickBooks sync fields
  quickbooksId          String?        @unique  // QB Invoice Id
  syncToken             String?        // QB sync token for updates
  lastSyncedAt          DateTime?      // When last synced with QB

  // Identification
  invoiceNumber         String         @unique  // INV-2024-0001
  docNumber             String?        // QB DocNumber

  // Customer reference
  customerId            Int
  customer              Customer       @relation(fields: [customerId], references: [id], onDelete: Restrict)

  // Sales Order reference (source of the invoice)
  salesOrderId          Int?
  salesOrder            SalesOrder?    @relation(fields: [salesOrderId], references: [id], onDelete: SetNull)

  // Status & dates
  status                InvoiceStatus  @default(DRAFT)
  txnDate               DateTime       @default(now())
  dueDate               DateTime?
  shipDate              DateTime?

  // Billing Address
  billAddrLine1         String?
  billAddrLine2         String?
  billAddrCity          String?
  billAddrState         String?
  billAddrPostalCode    String?
  billAddrCountry       String?

  // Shipping Address
  shipAddrLine1         String?
  shipAddrLine2         String?
  shipAddrCity          String?
  shipAddrState         String?
  shipAddrPostalCode    String?
  shipAddrCountry       String?

  // Totals
  subtotal              Float          @default(0)
  taxAmount             Float          @default(0)
  totalAmount           Float          @default(0)
  balance               Float          @default(0)

  // Notes
  customerMemo          String?        @db.Text // Visible to customer
  privateNote           String?        @db.Text // Internal only

  // Audit
  createdById           Int?
  createdBy             User?          @relation("InvoiceCreatedBy", fields: [createdById], references: [id], onDelete: SetNull)

  createdAt             DateTime       @default(now())
  updatedAt             DateTime       @updatedAt

  // Relations
  lines                 InvoiceLine[]

  @@map("Invoices")
}

// Invoice Line Item
model InvoiceLine {
  id                    Int       @id @default(autoincrement())
  invoiceId             Int
  invoice               Invoice   @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  // Line number for ordering
  lineNum               Int       @default(0)

  // Item reference (QB Item)
  itemRefId             String?   // QB: SalesItemLineDetail.ItemRef.value
  itemRefName           String?   // QB: SalesItemLineDetail.ItemRef.name

  // Line details
  description           String?   // QB: Description
  quantity              Float     @default(1) // QB: Qty
  unitPrice             Float     @default(0) // QB: UnitPrice
  amount                Float     @default(0) // QB: Amount (qty * unitPrice)

  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@map("InvoiceLines")
}

// Portal - Subdomain-based access portals with restricted tabs
model Portal {
  id          Int      @id @default(autoincrement())
  subdomain   String   @unique  // "purchasing", "sales", "admin", etc.
  name        String             // "Purchasing Portal"
  description String?
  tabs        String[] @default([])  // Allowed tabs for this portal
  defaultTab  String?            // Landing tab (must be in tabs array)
  headerTitle String?            // Custom header text
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("Portals")
}

// Price History - Track price changes for purchasing analytics
model PriceHistory {
  id              Int         @id @default(autoincrement())
  vendorId        Int
  vendor          Vendor      @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  masterPartId    Int?
  masterPart      MasterPart? @relation(fields: [masterPartId], references: [id], onDelete: SetNull)
  sku             String?
  description     String?
  unitPrice       Float
  previousPrice   Float?
  priceChange     Float?
  percentChange   Float?
  sourceType      String      // 'PURCHASE_ORDER', 'MANUAL', 'QUOTE'
  sourceId        Int?
  effectiveDate   DateTime    @default(now())
  createdAt       DateTime    @default(now())

  @@index([vendorId])
  @@index([masterPartId])
  @@index([effectiveDate])
  @@map("PriceHistory")
}
