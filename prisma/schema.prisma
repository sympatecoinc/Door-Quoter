generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x", "debian-openssl-1.1.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Project {
  id                     Int                @id @default(autoincrement())
  name                   String
  status                 ProjectStatus      @default(STAGING)
  customerId             Int
  pricingModeId          Int?
  extrusionCostingMethod String             @default("FULL_STOCK") // "FULL_STOCK" | "PERCENTAGE_BASED"
  excludedPartNumbers    String[]           @default([]) // Part numbers to exclude from FULL_STOCK rule (use percentage-based instead)
  multiplier             Float              @default(1.0) // Price multiplier/markup for quotes (e.g., 1.2 = 20% markup)
  taxRate                Float              @default(0) // Tax rate as decimal (e.g., 0.08 for 8%)
  installationCost       Float              @default(0) // DEPRECATED - kept for backward compatibility, use manualInstallationCost
  installationMethod     String             @default("MANUAL") // "MANUAL" or "PER_PRODUCT_TOTAL"
  installationComplexity String             @default("STANDARD") // "SIMPLE", "STANDARD", "COMPLEX", "VERY_COMPLEX"
  manualInstallationCost Float              @default(0) // Manual installation cost (preserved when switching modes)
  createdAt              DateTime           @default(now())
  updatedAt              DateTime           @updatedAt
  dueDate                DateTime?
  shipDate               DateTime?          // Expected ship/delivery date
  shippingAddress        String?            // Shipping street address
  shippingCity           String?            // Shipping city
  shippingState          String?            // Shipping state
  shippingZipCode        String?            // Shipping zip code
  primaryContactId       Int?               // Primary contact from customer's contacts
  primaryProjectContactId Int?              // Primary contact from project contacts
  boms                   BOM[]
  openings               Opening[]
  quoteAttachments       QuoteAttachment[]
  statusHistory          ProjectStatusHistory[]
  projectContacts        ProjectContact[]   // Project-specific contacts (architect, GC, etc.)
  projectNotes           ProjectNote[]      // Project notes
  customer               Customer           @relation("CustomerProjects", fields: [customerId], references: [id], onDelete: Restrict)
  pricingMode            PricingMode?       @relation(fields: [pricingModeId], references: [id], onDelete: SetNull)
  primaryContact         Contact?           @relation("ProjectPrimaryContact", fields: [primaryContactId], references: [id], onDelete: SetNull)
  primaryProjectContact  ProjectContact?    @relation("ProjectPrimaryProjectContact", fields: [primaryProjectContactId], references: [id], onDelete: SetNull)

  @@map("Projects")
}

model ProjectStatusHistory {
  id        Int           @id @default(autoincrement())
  projectId Int
  status    ProjectStatus
  changedBy String?
  changedAt DateTime      @default(now())
  project   Project       @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@map("ProjectStatusHistory")
}

model Opening {
  id                 Int       @id @default(autoincrement())
  projectId          Int
  name               String
  roughWidth         Float?
  roughHeight        Float?
  finishedWidth      Float?
  finishedHeight     Float?
  price              Float     @default(0)
  standardOptionCost Float     @default(0) // Cost of standard options (no markup applied)
  multiplier         Float     @default(1.0) // Price multiplier/markup for this opening (e.g., 1.2 = 20% markup)
  priceCalculatedAt  DateTime? // Track when price was last calculated
  finishColor       String?   // Finish type for extrusions (e.g., "Mill Finish", "Powder Coated", "Anodized")
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  project           Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  panels            Panel[]

  @@map("Openings")
}

model Panel {
  id                  Int                @id @default(autoincrement())
  openingId           Int
  type                String
  width               Float
  height              Float
  glassType           String
  locking             String
  swingDirection      String             @default("None")
  slidingDirection    String             @default("Left")
  isCorner            Boolean            @default(false)
  cornerDirection     String             @default("Up")
  displayOrder        Int                @default(0) // Order for display in UI
  componentLibraryId  Int?               // Link to component library for parametric SVGs
  createdAt           DateTime           @default(now())
  updatedAt           DateTime           @updatedAt
  componentInstance   ComponentInstance?
  componentLibrary    ComponentLibrary?  @relation(fields: [componentLibraryId], references: [id], onDelete: SetNull)
  opening             Opening            @relation(fields: [openingId], references: [id], onDelete: Cascade)

  @@map("Panels")
}

enum ProjectStatus {
  STAGING        @map("Staging")
  APPROVED       @map("Approved")
  REVISE         @map("Revise")
  QUOTE_SENT     @map("Quote Sent")
  QUOTE_ACCEPTED @map("Quote Accepted")
  ACTIVE         @map("Active")
  COMPLETE       @map("Complete")
  ARCHIVE        @map("Archive")
}

enum ProductType {
  SWING_DOOR   @map("Swing Door")
  SLIDING_DOOR @map("Sliding Door")
  FIXED_PANEL  @map("Fixed Panel")
  CORNER_90    @map("90 Degree Corner")
}

model Product {
  id                   Int                    @id @default(autoincrement())
  name                 String
  description          String?
  type                 String                 @default("Product")
  productType          ProductType            @default(SWING_DOOR)
  archived             Boolean                @default(false)
  glassWidthFormula    String?
  glassHeightFormula   String?
  glassQuantityFormula String?
  elevationImageData   String?                // Base64 encoded elevation image
  elevationFileName    String?                // Original elevation filename
  installationPrice    Float                  @default(0) // Installation cost for this product type (optional)
  createdAt            DateTime               @default(now())
  updatedAt            DateTime               @updatedAt
  componentInstances   ComponentInstance[]
  productBOMs          ProductBOM[]
  productSubOptions    ProductSubOption[]
  planViews            ProductPlanView[]
  productDocuments     ProductQuoteDocument[] // Documents associated with this product

  @@map("Products")
}

model SubOptionCategory {
  id                Int                @id @default(autoincrement())
  name              String
  description       String?
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  individualOptions IndividualOption[]
  productSubOptions ProductSubOption[]

  @@map("SubOptionCategories")
}

model IndividualOption {
  id                          Int                @id @default(autoincrement())
  categoryId                  Int
  name                        String
  description                 String?
  partNumber                  String?
  price                       Float              @default(0)
  addToPackingList            Boolean            @default(false)
  addFinishToPartNumber       Boolean            @default(false)
  createdAt                   DateTime           @default(now())
  updatedAt                   DateTime           @updatedAt
  category                    SubOptionCategory  @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  productSubOptionsAsStandard ProductSubOption[] @relation("StandardOption")

  @@map("IndividualOptions")
}

model ProductSubOption {
  id               Int                @id @default(autoincrement())
  productId        Int
  categoryId       Int
  standardOptionId Int?
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt
  category         SubOptionCategory  @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  product          Product            @relation(fields: [productId], references: [id], onDelete: Cascade)
  standardOption   IndividualOption?  @relation("StandardOption", fields: [standardOptionId], references: [id], onDelete: SetNull)

  @@unique([productId, categoryId])
  @@map("ProductSubOptions")
}

model BOM {
  id           Int      @id @default(autoincrement())
  projectId    Int
  materialType String
  partName     String
  quantity     Float
  unit         String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  project      Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@map("BOMs")
}

model ProductBOM {
  id          Int      @id @default(autoincrement())
  productId   Int
  partType    String   @default("Hardware")
  partName    String
  description String?
  formula     String?
  variable    String?
  unit        String?
  quantity    Float?
  stockLength Float?
  partNumber            String?
  cost                  Float?
  addFinishToPartNumber Boolean  @default(false) // When true, append finish color code to hardware part number in BOM
  addToPackingList      Boolean  @default(false) // When true, this hardware item appears in the packing list
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  product               Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@map("ProductBOMs")
}

model ComponentInstance {
  id                  Int      @id @default(autoincrement())
  panelId             Int      @unique
  productId           Int
  subOptionSelections String
  includedOptions     String   @default("[]") // JSON array: [optionId1, optionId2, ...] - options marked as included (no charge)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  product             Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  panel               Panel    @relation(fields: [panelId], references: [id], onDelete: Cascade)

  @@map("ComponentInstances")
}

model MasterPart {
  id                      Int                @id @default(autoincrement())
  partNumber              String             @unique
  baseName                String
  description             String?
  unit                    String?
  cost                    Float?
  weightPerUnit           Float?             // Weight in ounces for Hardware parts
  weightPerFoot           Float?             // Weight in ounces per linear foot for Extrusion parts
  partType                String             @default("Hardware")
  isMillFinish            Boolean            @default(false) // If true (for Extrusions), no finish codes (-BL, -C2, -AL) will be appended to part numbers
  isOption                Boolean            @default(false) // True if this hardware part can be used as a category option
  optionImagePath         String?            // Path to uploaded image for category options (relative to public/)
  optionImageOriginalName String?            // Original filename of uploaded image
  addFinishToPartNumber   Boolean            @default(false) // When true, append finish color code to hardware part number in BOM
  addToPackingList        Boolean            @default(false) // When true, this hardware item appears in the packing list
  createdAt               DateTime           @default(now())
  updatedAt               DateTime           @updatedAt
  stockLengthRules        StockLengthRule[]
  pricingRules            PricingRule[]

  @@map("MasterParts")
}

model StockLengthRule {
  id             Int        @id @default(autoincrement())
  name           String
  description    String?
  minHeight      Float?
  maxHeight      Float?
  minWidth       Float?
  maxWidth       Float?
  stockLength    Float?     // For inch-based parts
  piecesPerUnit  Float?     // For unit-based parts
  maxLength      Float?     // Maximum length constraint
  maxLengthAppliesTo String? @default("height") // "height" or "width" - what the max length constraint is based on
  appliesTo      String     @default("height") // "height", "width", or "both"
  partType       String     @default("Extrusion")
  isActive       Boolean    @default(true)
  // Pricing fields for extrusions (pricing based on stock length)
  basePrice      Float?     // Base price for extrusions
  weightPerFoot  Float?     // Weight in ounces per linear foot for extrusions
  formula        String?    // e.g., "basePrice * (stockLength / 96)" or "basePrice * quantity"
  minQuantity    Float?
  maxQuantity    Float?
  masterPartId   Int        // Required - always tied to a master part
  masterPart     MasterPart @relation(fields: [masterPartId], references: [id], onDelete: Cascade)
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt

  @@map("StockLengthRules")
}

model PricingRule {
  id           Int        @id @default(autoincrement())
  name         String
  description  String?
  basePrice    Float?
  formula      String?    // e.g., "basePrice * quantity" or "width * height * pricePerSqFt"
  minQuantity  Float?
  maxQuantity  Float?
  partType     String     @default("Hardware")
  category     String?
  isActive     Boolean    @default(true)
  masterPartId Int        // Required - always tied to a master part
  masterPart   MasterPart @relation(fields: [masterPartId], references: [id], onDelete: Cascade)
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  @@map("PricingRules")
}

// CRM Models
model Customer {
  id          Int        @id @default(autoincrement())
  companyName String
  contactName String?
  email       String?    @unique
  phone       String?
  address     String?
  city        String?
  state       String?
  zipCode     String?
  country     String?    @default("USA")
  status      String     @default("Active") // Active, Inactive, Prospect
  source      String?    // How they found us
  notes       String?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  contacts    Contact[]
  leads       Lead[]
  projects    Project[]  @relation("CustomerProjects")
  activities  Activity[]
  files       CustomerFile[]

  @@map("Customers")
}

model Contact {
  id         Int       @id @default(autoincrement())
  customerId Int
  firstName  String
  lastName   String
  email      String?
  phone      String?
  title      String?
  isPrimary  Boolean   @default(false)
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  customer   Customer  @relation(fields: [customerId], references: [id], onDelete: Cascade)
  projects   Project[] @relation("ProjectPrimaryContact")

  @@map("Contacts")
}

model Lead {
  id          Int        @id @default(autoincrement())
  customerId  Int?
  title       String
  description String?
  value       Float?     // Estimated project value
  probability Int        @default(50) // Percentage 0-100
  stage       String     @default("New") // New, Qualified, Proposal, Negotiation, Won, Lost
  source      String?    // Website, Referral, Cold Call, etc.
  expectedCloseDate DateTime?
  actualCloseDate   DateTime?
  lostReason  String?    // If stage is Lost
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  customer    Customer?  @relation(fields: [customerId], references: [id], onDelete: SetNull)
  activities  Activity[]

  @@map("Leads")
}

model Activity {
  id          Int      @id @default(autoincrement())
  leadId      Int?
  customerId  Int?
  type        String   // Call, Email, Meeting, Note, Task
  subject     String
  description String?
  dueDate     DateTime?
  completed   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  lead        Lead?    @relation(fields: [leadId], references: [id], onDelete: Cascade)
  customer    Customer? @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@map("Activities")
}

model CustomerFile {
  id           Int      @id @default(autoincrement())
  customerId   Int
  filename     String   // Stored filename
  originalName String   // Original upload filename
  mimeType     String
  size         Int      // File size in bytes
  uploadedBy   String?  // User who uploaded the file
  createdAt    DateTime @default(now())
  customer     Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@map("CustomerFiles")
}

// Quote Attachments - Spec sheets, photos, etc. for quotes
model QuoteAttachment {
  id           Int      @id @default(autoincrement())
  projectId    Int
  filename     String   // Stored filename in uploads/quote-attachments/[projectId]/
  originalName String   // Original upload filename
  mimeType     String   // image/png, image/jpeg, application/pdf
  size         Int      // File size in bytes
  type         String   @default("custom") // "spec_sheet", "photo", "custom"
  displayOrder Int      @default(0) // Order in the PDF
  position     String   @default("after") // "before" or "after" - position relative to persistent documents
  description  String?  // Optional description/caption
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  project      Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@map("QuoteAttachments")
}

// Project Contacts - Architects, GCs, and other project-specific contacts
model ProjectContact {
  id               Int       @id @default(autoincrement())
  projectId        Int
  contactType      String    // "ARCHITECT" | "GENERAL_CONTRACTOR" | "OTHER"
  companyName      String?
  name             String
  email            String?
  phone            String?
  notes            String?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  project          Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  primaryForProjects Project[] @relation("ProjectPrimaryProjectContact")

  @@map("ProjectContacts")
}

// Project Notes - Notes specific to a project
model ProjectNote {
  id        Int      @id @default(autoincrement())
  projectId Int
  content   String   @db.Text
  createdBy String?  // User who created the note
  updatedBy String?  // User who last updated the note
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@map("ProjectNotes")
}

// Component Library for SHOPGEN Integration
model ComponentLibrary {
  id                   Int      @id @default(autoincrement())
  name                 String   @unique
  description          String?
  hasSwingDirection    Boolean  @default(false)
  hasSlidingDirection  Boolean  @default(false)
  elevationImageData   String?  // Base64 encoded SVG/PNG data
  planImageData        String?  // Base64 encoded SVG/PNG data
  elevationFileName    String?  // Original filename
  planFileName         String?  // Original filename
  isParametric         Boolean  @default(true) // Whether this component uses parametric scaling
  productType          ProductType @default(SWING_DOOR)
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  panels               Panel[]  // Panels using this component

  @@map("ComponentLibrary")
}

// Product Plan Views - Multiple named plan views per product for swing directions
model ProductPlanView {
  id           Int      @id @default(autoincrement())
  productId    Int
  name         String   // e.g., "Right-In", "Right-Out", "Left-In", "Left-Out"
  imageData    String   // Base64 encoded plan view image
  fileName     String?  // Original filename
  fileType     String   @default("image/png") // MIME type of the uploaded file
  orientation  String   @default("bottom") // "bottom" (align top) or "top" (align bottom)
  displayOrder Int      @default(0) // Order for display in UI
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  product      Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@map("ProductPlanViews")
}

// Add customer relationship to existing Project model

// Glass Types - Pricing for glass by square foot
model GlassType {
  id           Int      @id @default(autoincrement())
  name         String   @unique
  description  String?
  pricePerSqFt Float
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@map("GlassTypes")
}

// Pricing Modes - Configurable pricing strategies for projects
model PricingMode {
  id              Int       @id @default(autoincrement())
  name            String    @unique
  description     String?
  isDefault       Boolean   @default(false)
  markup          Float     @default(0) // Global markup percentage (e.g., 20 for 20%) - kept for backward compatibility
  extrusionMarkup Float     @default(0) // Extrusion-specific markup percentage
  hardwareMarkup  Float     @default(0) // Hardware-specific markup percentage
  glassMarkup     Float     @default(0) // Glass-specific markup percentage
  discount        Float     @default(0) // Global discount percentage (e.g., 10 for 10%)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  projects        Project[]

  @@map("PricingModes")
}

// Authentication and User Management
enum Role {
  ADMIN
  MANAGER
  VIEWER
}

model User {
  id           Int       @id @default(autoincrement())
  email        String    @unique
  passwordHash String
  name         String
  role         Role      @default(VIEWER)
  isActive     Boolean   @default(true)
  permissions  String[]  @default(["dashboard", "projects", "crm", "products", "masterParts", "quoteDocuments", "accounting", "settings"]) // Available tabs for user
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  sessions     Session[]

  @@map("Users")
}

model Session {
  id        String   @id @default(uuid())
  userId    Int
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("Sessions")
}

// Quote Documents - Persistent documents that can be included in quotes
model QuoteDocument {
  id               Int                    @id @default(autoincrement())
  name             String                 // Display name
  description      String?                // Optional description
  filename         String                 // Stored filename (unique identifier)
  originalName     String                 // Original upload filename
  mimeType         String                 // File MIME type
  size             Int                    // File size in bytes
  category         String                 @default("general") // "spec_sheet", "brochure", "warranty", "installation", "general"
  isGlobal         Boolean                @default(true) // If true, included in all quotes
  displayOrder     Int                    @default(0) // Order in PDFs
  uploadedBy       String?                // User who uploaded
  createdAt        DateTime               @default(now())
  updatedAt        DateTime               @updatedAt
  productDocuments ProductQuoteDocument[] // Products this document is associated with

  @@map("QuoteDocuments")
}

// Junction table linking products to quote documents
model ProductQuoteDocument {
  id              Int           @id @default(autoincrement())
  productId       Int
  quoteDocumentId Int
  createdAt       DateTime      @default(now())
  product         Product       @relation(fields: [productId], references: [id], onDelete: Cascade)
  quoteDocument   QuoteDocument @relation(fields: [quoteDocumentId], references: [id], onDelete: Cascade)

  @@unique([productId, quoteDocumentId])
  @@map("ProductQuoteDocuments")
}

// Extrusion Finish Pricing - Global settings for finish costs per foot
model ExtrusionFinishPricing {
  id              Int      @id @default(autoincrement())
  finishType      String   @unique // e.g., "Mill Finish", "Powder Coated", "Anodized"
  finishCode      String?  // Part number suffix code (e.g., "BL", "C2", "AL")
  costPerFoot     Float    @default(0) // Additional cost per foot of extrusion
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("ExtrusionFinishPricing")
}
